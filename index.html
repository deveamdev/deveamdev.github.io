<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Deveam Support</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        margin: 0;
        font-family: Inter, sans-serif;
        background: #0e0f11;
        color: #fff;
    }

    /* ==== HEADER ==== */
    .header {
        font-size: 24px;
        font-weight: 700;
        text-align: center;
        padding: 20px;
        background: rgba(255,255,255,0.03);
        border-bottom: 1px solid rgba(255,255,255,0.08);
        backdrop-filter: blur(10px);
    }

    /* ==== VIEWS ==== */
    .view {
        display: none;
        padding: 20px;
        animation: fade .25s ease;
    }

    @keyframes fade {
        from {opacity: 0;}
        to {opacity: 1;}
    }

    /* ==== BOTTOM NAV ==== */
    .tabs {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #0c0d0f;
        display: flex;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .tab {
        flex: 1;
        text-align: center;
        padding: 13px 0;
        color: #888;
        font-size: 14px;
        cursor: pointer;
    }

    .tab.active {
        color: #3ea6ff;
        font-weight: 600;
    }

    /* ==== CARDS ==== */
    .card {
        background: rgba(255,255,255,0.05);
        padding: 16px;
        margin-bottom: 14px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.08);
    }

    textarea {
        width: 100%;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 14px;
        padding: 12px;
        color: #fff;
        resize: none;
        font-size: 15px;
    }

    .btn {
        width: 100%;
        margin-top: 12px;
        padding: 14px;
        background: linear-gradient(135deg, #e85287, #c53361);
        border-radius: 12px;
        border: none;
        color: #fff;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
    }

    .ticket {
        background: rgba(255,255,255,0.07);
        border: 1px solid rgba(255,255,255,0.12);
        padding: 14px;
        border-radius: 14px;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .status {
        font-size: 13px;
        margin-top: 6px;
        opacity: 0.8;
    }

    .open{color:#3ea6ff;}
    .pending{color:#ffcd4a;}
    .closed{color:#6aff6a;}

    /* Ticket page */
    .ticket-view-text {
        font-size: 16px;
        margin-bottom: 10px;
    }

    .admin-btn {
        padding: 8px 12px;
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 10px;
        display: inline-block;
        margin-right: 6px;
        cursor: pointer;
    }

</style>
</head>

<body>

<div class="header" id="headerTitle">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>

<!-- ==================== VIEW 1 ‚Äî SUPPORT ==================== -->
<div class="view" id="view-support" style="display:block;">
    <div class="card">
        <textarea id="supportText" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>
        <button class="btn" onclick="sendTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<!-- ==================== VIEW 2 ‚Äî MY TICKETS ==================== -->
<div class="view" id="view-my">
    <div id="myTickets"></div>
</div>

<!-- ==================== VIEW 3 ‚Äî ADMIN PANEL ==================== -->
<div class="view" id="view-admin">
    <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
    <div id="adminTickets"></div>
</div>

<!-- ==================== VIEW 4 ‚Äî PROFILE ==================== -->
<div class="view" id="view-profile">
    <div class="card">
        <h2 id="profileName"></h2>
        <div id="profileUsername"></div>
        <div style="opacity:.7;margin-top:5px;" id="profileId"></div>
    </div>
</div>

<!-- ==================== BOTTOM NAV ==================== -->
<div class="tabs">
    <div class="tab active" onclick="openTab('support', this)">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
    <div class="tab" onclick="openTab('my', this)">–¢–∏–∫–µ—Ç—ã</div>
    <div class="tab" id="tabAdmin" style="display:none;" onclick="openTab('admin', this)">–ê–¥–º–∏–Ω</div>
    <div class="tab" onclick="openTab('profile', this)">–ü—Ä–æ—Ñ–∏–ª—å</div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* ====================== INIT ====================== */

let tg = window.Telegram.WebApp;
tg.expand();

const API = "https://gimmicky-seamlessly-reinaldo.ngrok-free.dev";

let user = tg.initDataUnsafe.user;
let ADMIN = 8339987136;
let isAdmin = user.id === ADMIN;

document.getElementById("profileName").innerText = user.first_name;
document.getElementById("profileUsername").innerText = user.username ? "@" + user.username : "–ë–µ–∑ username";
document.getElementById("profileId").innerText = "ID: " + user.id;

if (isAdmin) {
    document.getElementById("tabAdmin").style.display = "block";
}

/* ====================== TABS ====================== */
function openTab(name, el) {
    document.querySelectorAll(".view").forEach(v => v.style.display = "none");
    document.getElementById("view-" + name).style.display = "block";

    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    el.classList.add("active");

    const titles = {
        support: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞",
        my: "–ú–æ–∏ —Ç–∏–∫–µ—Ç—ã",
        admin: "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å",
        profile: "–ü—Ä–æ—Ñ–∏–ª—å"
    };
    document.getElementById("headerTitle").innerText = titles[name];
}

/* ====================== SEND TICKET ====================== */
function sendTicket() {
    let text = document.getElementById("supportText").value.trim();
    if (!text) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!");

    fetch(API + "/new_ticket", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            user_id: user.id,
            username: user.username || "",
            text: text
        })
    });

    document.getElementById("supportText").value = "";
    tg.showPopup({title:"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", message:"–¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω"});
}

/* ====================== LOAD TICKETS ====================== */
function loadMyTickets() {
    fetch(API + "/tickets?user_id=" + user.id)
        .then(r => r.json())
        .then(list => {
            let box = document.getElementById("myTickets");
            box.innerHTML = "";

            list.forEach(t => {
                let d = document.createElement("div");
                d.className = "ticket";
                d.onclick = () => openTicket(t);
                d.innerHTML = `
                    <div>${t.text}</div>
                    <div class="status ${t.status}">
                        ${t.status=="open"?"üîµ –û—Ç–∫—Ä—ã—Ç":t.status=="pending"?"üü° –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏":"‚úÖ –ó–∞–∫—Ä—ã—Ç"}
                    </div>
                `;
                box.appendChild(d);
            });
        });
}

/* ====================== ADMIN TICKETS ====================== */
function loadAdminTickets() {
    if (!isAdmin) return;

    fetch(API + "/tickets?user_id=" + ADMIN)
        .then(r => r.json())
        .then(list => {
            let box = document.getElementById("adminTickets");
            box.innerHTML = "";

            list.forEach(t => {
                let d = document.createElement("div");
                d.className = "ticket";
                d.onclick = () => openTicket(t);
                d.innerHTML = `
                    <b>@${t.username}</b><br>
                    ${t.text}
                    <div class="status ${t.status}">
                        ${t.status=="open"?"üîµ –û—Ç–∫—Ä—ã—Ç":t.status=="pending"?"üü° –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏":"‚úÖ –ó–∞–∫—Ä—ã—Ç"}
                    </div>
                `;
                box.appendChild(d);
            });
        });
}

/* ====================== OPEN TICKET PAGE ====================== */
function openTicket(t) {
    let html = `
        <div class="card">
            <div class="ticket-view-text">${t.text}</div>
            <div class="status ${t.status}">
                ${t.status=="open"?"üîµ –û—Ç–∫—Ä—ã—Ç":t.status=="pending"?"üü° –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏":"‚úÖ –ó–∞–∫—Ä—ã—Ç"}
            </div>
        `;

    if (isAdmin) {
        html += `
            <br>
            <div class="admin-btn" onclick="setStatus(${t.id},'pending')">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
            <div class="admin-btn" onclick="setStatus(${t.id},'closed')">–ó–∞–∫—Ä—ã—Ç</div>
        `;
    }

    html += `</div>`;

    document.getElementById("view-my").innerHTML = html;
    openTab("my", document.querySelectorAll(".tab")[1]);
}

function setStatus(id, status) {
    fetch(API + "/update_status", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({id:id, status:status})
    });

    tg.showPopup({title:"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ", message:"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω"});
}

/* AUTO-REFRESH */
setInterval(loadMyTickets, 1500);
setInterval(loadAdminTickets, 1500);

loadMyTickets();
loadAdminTickets();

</script>
</body>
</html>
