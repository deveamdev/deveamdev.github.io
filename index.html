<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Deveam Support</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            background: #0b0d10;
            margin: 0;
            padding: 20px;
            font-family: Inter, sans-serif;
            color: #fff;
        }

        .title {
            font-size: 26px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: #3ea6ff;
        }

        .block {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        textarea {
            width: 100%;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 12px;
            padding: 12px;
            font-size: 15px;
            color: #fff;
            resize: none;
            outline: none;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #e85287, #c23364);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 17px;
            font-weight: 600;
            margin-top: 10px;
        }

        .ticket {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.10);
        }

        .status {
            font-size: 14px;
            margin-top: 6px;
            opacity: 0.8;
        }

        .open { color: #3ea6ff; }
        .pending { color: #ffc34d; }
        .closed { color: #6eff6e; }

        .adminBtn {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            color: #fff;
            font-size: 13px;
            margin-right: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="title">Deveam Support</div>

<!-- USER MESSAGE BOX -->
<div class="block" id="userPanel">
    <textarea id="text" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>
    <button onclick="sendTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<!-- ADMIN ONLY -->
<div class="block" id="replyBox" style="display:none;">
    <h3>–ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å</h3>
    <div id="adminTickets"></div>
</div>

<!-- USER'S TICKETS -->
<div class="block">
    <h3>–í–∞—à–∏ —Ç–∏–∫–µ—Ç—ã</h3>
    <div id="tickets"></div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const API = "https://gimmicky-seamlessly-reinaldo.ngrok-free.dev";

    let user = tg.initDataUnsafe.user;
    let ADMIN = 8339987136;
    let isAdmin = (user.id === ADMIN);

    if (isAdmin) {
        document.getElementById("replyBox").style.display = "block";
    }

    function sendTicket() {
        let text = document.getElementById("text").value.trim();
        if (!text) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");

        fetch(API + "/new_ticket", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                user_id: user.id,
                username: user.username || "",
                text: text
            })
        });

        document.getElementById("text").value = "";
        tg.showPopup({title: "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", message: "–í–∞—à —Ç–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω"});
    }

    function loadTickets() {
        fetch(`${API}/tickets?user_id=${user.id}`)
            .then(r => r.json())
            .then(data => {
                let box = document.getElementById("tickets");
                box.innerHTML = "";

                data.forEach(t => {
                    let div = document.createElement("div");
                    div.className = "ticket";
                    div.innerHTML = `
                        <div>${t.text}</div>
                        <div class="status ${t.status}">
                            ${t.status === "open" ? "üîµ –û—Ç–∫—Ä—ã—Ç" :
                              t.status === "pending" ? "üü° –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏" :
                              "‚úÖ –ó–∞–∫—Ä—ã—Ç"}
                        </div>
                    `;
                    box.appendChild(div);
                });
            });

        if (isAdmin) loadAdmin();
    }

    function loadAdmin() {
        fetch(`${API}/tickets?user_id=${ADMIN}`)
            .then(r => r.json())
            .then(data => {
                let box = document.getElementById("adminTickets");
                box.innerHTML = "";

                data.forEach(t => {
                    let div = document.createElement("div");
                    div.className = "ticket";
                    div.innerHTML = `
                        <div><b>@${t.username}</b></div>
                        <div>${t.text}</div>
                        <div class="status ${t.status}">
                            ${t.status === "open" ? "üîµ –û—Ç–∫—Ä—ã—Ç" :
                              t.status === "pending" ? "üü° –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏" :
                              "‚úÖ –ó–∞–∫—Ä—ã—Ç"}
                        </div>
                        <div style="margin-top:8px;">
                            <span class="adminBtn" onclick="setStatus(${t.id}, 'pending')">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
                            <span class="adminBtn" onclick="setStatus(${t.id}, 'closed')">–ó–∞–∫—Ä—ã—Ç</span>
                        </div>
                    `;
                    box.appendChild(div);
                });
            });
    }

    function setStatus(id, status) {
        fetch(API + "/update_status", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({id: id, status: status})
        });
    }

    setInterval(loadTickets, 1200);
    loadTickets();
</script>

</body>
</html>
