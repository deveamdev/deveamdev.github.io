<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Deveam Support</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0d0e10;
            color: #fff;
            font-family: Inter, sans-serif;
            display: flex;
            justify-content: center;
        }

        .wrap {
            width: 100%;
            max-width: 420px;
            padding: 20px 18px 40px;
        }

        .title {
            font-size: 23px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 22px;
            letter-spacing: -0.3px;
            color: #ffffff;
        }

        /* ==== INPUT FRAGMENT STYLE ==== */
        .input-box {
            background: #111214;
            border: 1px solid #1b1c1f;
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 14px;
        }

        textarea {
            width: 100%;
            height: 80px;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            color: #fff;
            font-size: 15px;
            font-family: inherit;
        }

        textarea::placeholder {
            color: #6d6d6d;
        }

        /* ==== BUTTON FRAGMENT ==== */
        .btn {
            width: 100%;
            background: linear-gradient(135deg, #5865f2, #3c45c8);
            padding: 14px;
            border-radius: 14px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            border: none;
            margin-bottom: 22px;
            color: white;
            cursor: pointer;
        }
        .btn:active { opacity: 0.85; }

        /* ==== CARD LIST ==== */
        .card {
            background: #111214;
            border: 1px solid #1b1c1f;
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .ticket-id {
            font-size: 15px;
            opacity: 0.6;
            margin-bottom: 6px;
        }

        .ticket-text {
            font-size: 15px;
            margin-bottom: 10px;
            line-height: 1.35;
        }

        .status {
            font-size: 14px;
            font-weight: 600;
        }

        .open { color: #4da3ff; }
        .pending { color: #f7c843; }
        .closed { color: #65d96a; }

        /* ===== ADMIN BUTTONS ===== */
        .admin-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .adm-btn {
            flex: 1;
            background: #1b1c1f;
            border-radius: 12px;
            padding: 10px;
            color: #fff;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #2a2b2e;
        }

        .adm-btn.blue { color: #4da3ff; border-color: #4da3ff; }
        .adm-btn.yellow { color: #f7c843; border-color: #f7c843; }
        .adm-btn.red { color: #ff4d4d; border-color: #ff4d4d; }

        #replyBox {
            display: none;
            margin-bottom: 18px;
        }

        #replyField {
            width: 100%;
            padding: 12px;
            background: #111214;
            border: 1px solid #1b1c1f;
            border-radius: 14px;
            font-size: 15px;
            color: #fff;
            margin-bottom: 10px;
            outline: none;
        }

    </style>
</head>
<body>

<div class="wrap">

    <div class="title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Deveam</div>

    <div id="userPanel">
        <div class="input-box">
            <textarea id="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>
        </div>
        <button class="btn" onclick="sendTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div id="replyBox">
        <input id="replyField" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...">
        <button class="btn" onclick="sendReply()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </div>

    <div id="tickets"></div>

</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>

    let tg = window.Telegram.WebApp;
    tg.expand();

    let user = tg.initDataUnsafe.user;
    let ADMIN = 8339987136;
    let isAdmin = (user.id === ADMIN);

    const API = "https://YOUR-NGROK.ngrok-free.dev"; // ‚≠ê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–°–¢–ê–í–¨!

    let selectedTicket = null;


    if (isAdmin) {
        document.getElementById("userPanel").style.display = "none";
        document.getElementById("replyBox").style.display = "block";
    }


    function sendTicket() {
        let text = document.getElementById("text").value.trim();
        if (!text) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");

        fetch(API + "/new_ticket", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                user_id: user.id,
                username: user.username || "",
                text: text
            })
        });

        document.getElementById("text").value = "";
        tg.showPopup({title: "‚úÖ –ì–æ—Ç–æ–≤–æ", message: "–í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"});
    }


    function loadTickets() {
        fetch(API + "/tickets?user_id=" + user.id)
        .then(r => r.json())
        .then(data => renderTickets(data));
    }


    function renderTickets(tickets) {
        let block = document.getElementById("tickets");
        block.innerHTML = "";

        tickets.forEach(t => {

            let card = document.createElement("div");
            card.className = "card";

            card.innerHTML = `
                <div class="ticket-id">#${t.id} ‚Ä¢ @${t.username}</div>
                <div class="ticket-text">${t.text}</div>
                <div class="status ${t.status}">
                    ${t.status === "open" ? "üîµ –û—Ç–∫—Ä—ã—Ç" :
                       t.status === "pending" ? "üü° –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏" :
                       "‚úÖ –ó–∞–∫—Ä—ã—Ç"}
                </div>
            `;

            if (isAdmin) {
                let adminBtns = document.createElement("div");
                adminBtns.className = "admin-buttons";

                adminBtns.innerHTML = `
                    <div class="adm-btn blue" onclick="setStatus(${t.id}, 'open')">–û—Ç–∫—Ä—ã—Ç</div>
                    <div class="adm-btn yellow" onclick="setStatus(${t.id}, 'pending')">–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ</div>
                    <div class="adm-btn red" onclick="setStatus(${t.id}, 'closed')">–ó–∞–∫—Ä—ã—Ç</div>
                `;

                card.appendChild(adminBtns);

                card.onclick = () => {
                    selectedTicket = t.id;
                };
            }

            block.appendChild(card);
        });
    }


    function setStatus(id, status) {
        fetch(API + "/update_status", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({id, status})
        });
    }


    function sendReply() {
        if (!selectedTicket) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–∫–µ—Ç");

        fetch(API + "/reply", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                id: selectedTicket,
                answer: document.getElementById("replyField").value
            })
        });

        document.getElementById("replyField").value = "";
        tg.showPopup({title: "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", message: "–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"});
    }


    setInterval(loadTickets, 1200);
    loadTickets();

</script>

</body>
</html>
