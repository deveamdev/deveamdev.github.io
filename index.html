<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Deveam Support</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg: #0b0c10;
            --card: rgba(255,255,255,0.07);
            --border: rgba(255,255,255,0.13);
            --accent: #5662ff;
            --accent2: #23c4ff;
            --red: #ff4d4d;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: Inter, sans-serif;
            background: var(--bg);
            color: white;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 480px;
            width: 100%;
        }

        .header {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            color: transparent;
            text-align: center;
        }

        .glass {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 20px;
            backdrop-filter: blur(14px);
        }

        textarea, input {
            width: 100%;
            padding: 12px;
            border-radius: 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
            resize: none;
            font-size: 15px;
            margin-bottom: 12px;
        }

        .btn {
            width: 100%;
            padding: 13px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #bb3f6f, #e9608a);
            border: none;
            color: white;
            transition: 0.2s;
        }

        .btn:hover { opacity: 0.85; }

        .ticket {
            padding: 14px;
            background: rgba(255,255,255,0.06);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.12);
            margin-bottom: 14px;
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            opacity: 0.8;
        }

        .status {
            margin-top: 8px;
            font-size: 14px;
        }

        .open { color: #4da3ff; }
        .pending { color: #ffc34d; }
        .closed { color: #7dff73; }

        .admin-controls {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .admin-btn {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .admin-btn.red { color: var(--red); border-color: var(--red); }
        .admin-btn.blue { color: #4da3ff; border-color: #4da3ff; }
        .admin-btn.yellow { color: #ffc34d; border-color: #ffc34d; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">Deveam Support</div>

    <div id="userPanel" class="glass">
        <textarea id="text" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>
        <button class="btn" onclick="sendTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div id="adminReplyPanel" class="glass" style="display:none;">
        <input id="replyInput" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Ç–∏–∫–µ—Ç...">
        <button class="btn" onclick="sendReply()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </div>

    <div class="glass">
        <div id="tickets"></div>
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    let user = tg.initDataUnsafe.user;
    let ADMIN = 8339987136;
    let isAdmin = (user.id == ADMIN);

    const API = "https://gimmicky-seamlessly-reinaldo.ngrok-free.dev"; // ‚≠ê –í–°–¢–ê–í–¨ –°–í–û–ô NGROK

    let selectedTicket = null;

    if (isAdmin) {
        document.getElementById("userPanel").style.display = "none";
        document.getElementById("adminReplyPanel").style.display = "block";
    }

    function sendTicket() {
        let text = document.getElementById("text").value.trim();
        if (!text) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!");

        fetch(API + "/new_ticket", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                user_id: user.id,
                username: user.username || "",
                text: text
            })
        });

        document.getElementById("text").value = "";
        tg.showPopup({title: "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", message: "–í–∞—à —Ç–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω"});
    }

    function renderTickets(tickets) {
        let box = document.getElementById("tickets");
        box.innerHTML = "";

        tickets.forEach(t => {
            let div = document.createElement("div");
            div.className = "ticket";

            div.innerHTML = `
                <div class="ticket-header">
                    <span>#${t.id}</span>
                    <span>@${t.username}</span>
                </div>

                <div style="margin-top: 8px; font-size:15px;">${t.text}</div>

                <div class="status ${t.status}">
                    ${t.status === "open" ? "üîµ –û—Ç–∫—Ä—ã—Ç" :
                      t.status === "pending" ? "üü° –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏" :
                      "‚úÖ –ó–∞–∫—Ä—ã—Ç"}
                </div>
            `;

            if (isAdmin) {
                let controls = document.createElement("div");
                controls.className = "admin-controls";

                controls.innerHTML = `
                    <button class="admin-btn blue" onclick="setStatus(${t.id}, 'open')">–û—Ç–∫—Ä—ã—Ç</button>
                    <button class="admin-btn yellow" onclick="setStatus(${t.id}, 'pending')">–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ</button>
                    <button class="admin-btn red" onclick="setStatus(${t.id}, 'closed')">–ó–∞–∫—Ä—ã—Ç</button>
                `;

                div.appendChild(controls);

                div.onclick = () => {
                    selectedTicket = t.id;
                    document.getElementById("replyInput").value = "";
                };
            }

            box.appendChild(div);
        });
    }

    function loadTickets() {
        fetch(API + "/tickets?user_id=" + user.id)
        .then(r => r.json())
        .then(renderTickets);
    }

    function setStatus(id, status) {
        fetch(API + "/update_status", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({id, status})
        });
    }

    function sendReply() {
        if (!selectedTicket) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–∫–µ—Ç!");

        fetch(API + "/reply", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                id: selectedTicket,
                answer: document.getElementById("replyInput").value
            })
        });

        tg.showPopup({title: "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", message: "–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"});
    }

    setInterval(loadTickets, 1500);
    loadTickets();
</script>

</body>
</html>
